<!DOCTYPE html>
<html lang="fr">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>{{ auction.nom }} - Stampee</title>
	<link rel="stylesheet" href="/projetweb1/public/css/base.css">
<link rel="stylesheet" href="/projetweb1/public/css/variables.css">
<link rel="stylesheet" href="/projetweb1/public/css/utilities.css">
<link rel="stylesheet" href="/projetweb1/public/css/product-details.css">
<link rel="stylesheet" href="/projetweb1/public/css/button.css">
<link rel="stylesheet" href="/projetweb1/public/css/carousel.css">
<link rel="stylesheet" href="/projetweb1/public/css/header.css">
<link rel="stylesheet" href="/projetweb1/public/css/footer.css">
<link rel="stylesheet" href="/projetweb1/public/css/responsive.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
</head>
<body>
	<header class="header">
		<div class="header__content">
			<a href="/projetweb1/public/" class="header__logo-link">
<img src="/projetweb1/public/img/redcrownlogo.png" alt="Red Crown Logo" class="header__logo">
			</a>
			<h1 class="header__title">Stampee Auction House</h1>
			<nav class="header__nav">
				<ul class="header__nav-list">
					<li><a href="/projetweb1/public/" class="header__nav-link">Accueil</a></li>
					<li><a href="/projetweb1/public/auctions" class="header__nav-link">Ench√®res</a></li>
					{% if session.authenticated %}
						<li><a href="/projetweb1/public/auctions/favorites" class="header__nav-link">Mes Favoris</a></li>
						<li><a href="/projetweb1/public/auctions/create" class="header__nav-link">Cr√©er une Ench√®re</a></li>
					{% endif %}
					<li><a href="#" class="header__nav-link">√Ä propos</a></li>
					<li><a href="#" class="header__nav-link">Contact</a></li>
				</ul>
			</nav>
			<div class="header__actions">
				{% if session.authenticated %}
					<span class="header__user">Bonjour, {{ session.username }}</span>
					                    <a href="/projetweb1/public/logout" class="btn btn--secondary">D√©connexion</a>
                {% else %}
                    <a href="/projetweb1/public/login" class="btn btn--secondary">Connexion</a>
                    <a href="/projetweb1/public/register" class="btn btn--primary">Inscription</a>
				{% endif %}
			            </div>
            
            <button class="header__nav-toggle" aria-label="Toggle navigation">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </header>

	<main>
	<div class="auction-details">
		<div class="auction-header">
			<h1>{{ auction.nom }}</h1>
			<div class="auction-meta">
				<span class="country">{{ auction.pays_origine }}</span>
				<span class="condition">{{ auction.condition }}</span>
				{% if auction.certifie %}
					<span class="certified">‚úì Certifi√©</span>
				{% endif %}
			</div>
		</div>

		<div class="auction-content">
			<div class="auction-images">
				{% if images and images|length > 0 %}
					<div class="image-carousel">
						<div class="carousel-container">
							{% for image in images %}
								<div class="carousel-slide {% if loop.first %}active{% endif %}" data-slide="{{ loop.index0 }}">
									<img src="/projetweb1/{{ image.chemin }}" alt="{{ auction.nom }} - Image {{ loop.index }}">
								</div>
							{% endfor %}
						</div>
						
						{% if images|length > 1 %}
	
							<button class="carousel-nav carousel-prev" aria-label="Image pr√©c√©dente">‚Äπ</button>
							<button class="carousel-nav carousel-next" aria-label="Image suivante">‚Ä∫</button>
							

							<div class="carousel-indicators">
								{% for image in images %}
									<button class="indicator {% if loop.first %}active{% endif %}" data-slide="{{ loop.index0 }}" aria-label="Aller √† l'image {{ loop.index }}"></button>
								{% endfor %}
							</div>
						{% endif %}
					</div>
				{% endif %}
			</div>

			<div class="auction-info">
				<div class="price-section">
					<h3>{% if auction.prix_actuel and auction.prix_actuel > 0 %}Prix Actuel{% else %}Prix de D√©part{% endif %}</h3>
					<div class="current-price">{% if auction.prix_actuel and auction.prix_actuel > 0 %}{{ auction.prix_actuel }}{% else %}{{ auction.prix_plancher }}{% endif %} $</div>
					<div class="starting-price">Prix de d√©part: {{ auction.prix_plancher }} $</div>
					{% if auction.nombre_offres and auction.nombre_offres > 0 %}
						<div class="bid-count-display">{{ auction.nombre_offres }} offre{{ auction.nombre_offres > 1 ? 's' : '' }} re√ßue{{ auction.nombre_offres > 1 ? 's' : '' }}</div>
					{% endif %}
					
					{% if auction.date_fin %}
						<div class="auction-countdown">
							<h4>Temps Restant</h4>
							<div id="countdown" class="countdown-timer" data-end="{{ auction.date_fin }}">
								<span class="countdown-days">--</span>j
								<span class="countdown-hours">--</span>h
								<span class="countdown-minutes">--</span>m
								<span class="countdown-seconds">--</span>s
							</div>
						</div>
					{% endif %}
				</div>

				<div class="bidding-section">
					<h3>Placer une Offre</h3>
					{% if session.authenticated %}
						{% if auction.statut == 'Active' and auction.date_fin|date('U') > 'now'|date('U') %}
							<form id="bidForm" class="bid-form">
								<input type="hidden" id="auctionId" value="{{ auction.id_enchere }}">
								<div class="bid-input-group">
									<input type="number" id="bidAmount" step="0.01" min="{% if auction.prix_actuel and auction.prix_actuel > 0 %}{{ (auction.prix_actuel + 0.01) }}{% else %}{{ (auction.prix_plancher + 0.01) }}{% endif %}" placeholder="Montant de l'offre" required>
									<button type="submit" class="btn btn--primary">Ench√©rir</button>
								</div>
								<small>L'offre doit √™tre sup√©rieure au prix actuel</small>
							</form>
						{% else %}
							<div class="auction-ended">
								<p class="auction-status">Cette ench√®re est termin√©e</p>
								{% if auction.statut == 'Terminee' %}
									<p class="winner-info">
										{% if offres and offres|length > 0 %}
											Gagnant: {{ offres[0].nom_utilisateur }} avec {{ offres[0].montant }} $
										{% else %}
											Aucune offre re√ßue
										{% endif %}
									</p>
								{% endif %}
							</div>
						{% endif %}
					{% else %}
						<p>Connectez-vous pour ench√©rir</p>
						<a href="/projetweb1/public/login" class="btn btn--primary">Se Connecter</a>
					{% endif %}
				</div>

				<div class="auction-details-info">
					<h3>D√©tails de l'Ench√®re</h3>
					<ul>
						<li><strong>Vendeur:</strong> {{ auction.vendeur_nom }}</li>
						<li><strong>Date de d√©but:</strong> {{ auction.date_debut|date('d/m/Y H:i') }}</li>
						<li><strong>Date de fin:</strong> {{ auction.date_fin|date('d/m/Y H:i') }}</li>
						<li><strong>Nombre d'offres:</strong> {{ auction.nombre_offres }}</li>
						{% if auction.couleurs %}
							<li><strong>Couleurs:</strong> {{ auction.couleurs }}</li>
						{% endif %}
						{% if auction.tirage %}
							<li><strong>Tirage:</strong> {{ auction.tirage }}</li>
						{% endif %}
						{% if auction.dimensions %}
							<li><strong>Dimensions:</strong> {{ auction.dimensions }}</li>
						{% endif %}
					</ul>
				</div>

				<div class="favorite-section">
					{% if session.authenticated %}
						<button id="favoriteBtn" class="btn btn--secondary favorite-btn {{ isFavorite ? 'favorited' : '' }}" data-auction-id="{{ auction.id_enchere }}">
							{% if isFavorite %}
								‚ù§Ô∏è Retirer des Favoris
							{% else %}
								ü§ç Ajouter aux Favoris
							{% endif %}
						</button>
						
						{% if session.user_id == auction.id_membre %}
							<div class="owner-actions">
								<a href="/projetweb1/public/auctions/{{ auction.id_enchere }}/edit" class="btn btn--primary">‚úèÔ∏è Modifier l'Ench√®re</a>
								<button class="btn btn--danger delete-auction-btn" data-auction-id="{{ auction.id_enchere }}">üóëÔ∏è Supprimer l'Ench√®re</button>
							</div>
						{% endif %}
					{% endif %}
				</div>
			</div>
		</div>

		<div class="bids-history">
			<h3>Historique des Offres</h3>
			{% if offres %}
				<div class="bids-list">
					{% for offre in offres %}
					<div class="bid-item">
						<span class="bid-amount">{{ offre.montant }} $</span>
						<span class="bid-user">{{ offre.nom_utilisateur }}</span>
						<span class="bid-date">{{ offre.date_offre|date('d/m/Y H:i') }}</span>
					</div>
					{% endfor %}
				</div>
			{% else %}
				<p>Aucune offre pour le moment</p>
			{% endif %}
		</div>
	</div>
	</main>



	<script>
		document.addEventListener('DOMContentLoaded', function() {
			// Mobile navigation toggle
			const navToggle = document.querySelector('.header__nav-toggle');
			const navList = document.querySelector('.header__nav-list');
			
			if (navToggle && navList) {
				navToggle.addEventListener('click', function() {
					navList.classList.toggle('active');
					this.classList.toggle('active');
				});
			}

			// Countdown timer functionality
			const countdownElement = document.getElementById('countdown');
			if (countdownElement) {
				const endDate = new Date(countdownElement.dataset.end).getTime();
				
				function updateCountdown() {
					const now = new Date().getTime();
					const distance = endDate - now;
					
					if (distance < 0) {
						// Auction has ended
						countdownElement.innerHTML = '<span class="auction-ended">Ench√®re termin√©e</span>';
						return;
					}
					
					// Calculate time units
					const days = Math.floor(distance / (1000 * 60 * 60 * 24));
					const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
					const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
					const seconds = Math.floor((distance % (1000 * 60)) / 1000);
					
					// Update display
					countdownElement.querySelector('.countdown-days').textContent = days;
					countdownElement.querySelector('.countdown-hours').textContent = hours.toString().padStart(2, '0');
					countdownElement.querySelector('.countdown-minutes').textContent = minutes.toString().padStart(2, '0');
					countdownElement.querySelector('.countdown-seconds').textContent = seconds.toString().padStart(2, '0');
					
					// Add urgency styling for last 24 hours
					if (distance < 24 * 60 * 60 * 1000) {
						countdownElement.classList.add('urgent');
					}
				}
				
				// Update countdown every second
				updateCountdown();
				setInterval(updateCountdown, 1000);
			}

			// Carousel functionality
			const carousel = document.querySelector('.image-carousel');
			if (carousel) {
				const slides = carousel.querySelectorAll('.carousel-slide');
				const prevBtn = carousel.querySelector('.carousel-prev');
				const nextBtn = carousel.querySelector('.carousel-next');
				const indicators = carousel.querySelectorAll('.indicator');
				
				let currentSlide = 0;
				const totalSlides = slides.length;
				
				// Function to show a specific slide
				function showSlide(index) {
					// Remove active class from all slides and indicators
					slides.forEach(slide => slide.classList.remove('active'));
					indicators.forEach(indicator => indicator.classList.remove('active'));
					
					// Add active class to current slide and indicator
					slides[index].classList.add('active');
					if (indicators[index]) {
						indicators[index].classList.add('active');
					}
					
					currentSlide = index;
				}
				
				// Function to go to next slide
				function nextSlide() {
					const nextIndex = (currentSlide + 1) % totalSlides;
					showSlide(nextIndex);
				}
				
				// Function to go to previous slide
				function prevSlide() {
					const prevIndex = (currentSlide - 1 + totalSlides) % totalSlides;
					showSlide(prevIndex);
				}
				
				// Event listeners for navigation buttons
				if (prevBtn) {
					prevBtn.addEventListener('click', prevSlide);
				}
				
				if (nextBtn) {
					nextBtn.addEventListener('click', nextSlide);
				}
				
				// Event listeners for indicators
				indicators.forEach((indicator, index) => {
					indicator.addEventListener('click', () => showSlide(index));
				});
				
				// Keyboard navigation
				document.addEventListener('keydown', function(e) {
					if (carousel.contains(document.activeElement) || carousel === document.activeElement) {
						if (e.key === 'ArrowLeft') {
							e.preventDefault();
							prevSlide();
						} else if (e.key === 'ArrowRight') {
							e.preventDefault();
							nextSlide();
						}
					}
				});
				
				// Auto-advance slides every 5 seconds (optional)
				if (totalSlides > 1) {
					setInterval(nextSlide, 5000);
				}
			}

			// Enhanced Bidding functionality
			const bidForm = document.getElementById('bidForm');
			if (bidForm) {
				bidForm.addEventListener('submit', function(e) {
					e.preventDefault();
					
					const auctionId = document.getElementById('auctionId').value;
					const amount = document.getElementById('bidAmount').value;
					
					// Validate bid amount
					const currentPrice = parseFloat(document.querySelector('.current-price').textContent.replace('$', '').trim());
					if (parseFloat(amount) <= currentPrice) {
						alert('L\'offre doit √™tre sup√©rieure au prix actuel');
						return;
					}
					
					// Disable form during submission
					const submitBtn = this.querySelector('button[type="submit"]');
					const originalText = submitBtn.textContent;
					submitBtn.disabled = true;
					submitBtn.textContent = 'Envoi en cours...';
					
					fetch('/projetweb1/public/auctions/bid', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							auction_id: auctionId,
							montant: parseFloat(amount)
						})
					})
					.then(response => {
						console.log('Bid response status:', response.status);
						return response.text();
					})
					.then(text => {
						console.log('Bid response text:', text);
						try {
							const data = JSON.parse(text);
							console.log('Parsed bid data:', data);
							
							if (data.success) {
								alert(data.message);
								// Force a fresh reload to get updated data
								location.reload(true);
							} else {
								alert('Erreur: ' + data.error);
								// Re-enable form
								submitBtn.disabled = false;
								submitBtn.textContent = originalText;
							}
						} catch (parseError) {
							console.error('JSON parse error:', parseError);
							console.error('Raw bid response:', text);
							alert('Erreur de format de r√©ponse du serveur');
							// Re-enable form
							submitBtn.disabled = false;
							submitBtn.textContent = originalText;
						}
					})
					.catch(error => {
						console.error('Network error:', error);
						alert('Erreur de connexion lors de la soumission de l\'offre');
						// Re-enable form
						submitBtn.disabled = false;
						submitBtn.textContent = originalText;
					});
				});
			}

			// Favorite functionality
			const favoriteBtn = document.getElementById('favoriteBtn');
			if (favoriteBtn) {
				favoriteBtn.addEventListener('click', function() {
					const auctionId = this.dataset.auctionId;
					
					fetch('/projetweb1/public/auctions/favorite', {
						method: 'POST',
						headers: {
							'Content-Type': 'application/json',
						},
						body: JSON.stringify({
							auction_id: auctionId
						})
					})
					.then(response => {
						console.log('Response status:', response.status);
						console.log('Response headers:', response.headers);
						return response.text();
					})
					.then(text => {
						console.log('Response text:', text);
						try {
							const data = JSON.parse(text);
							console.log('Parsed data:', data);
							
							if (data.success) {
								if (data.isFavorite) {
									this.innerHTML = '‚ù§Ô∏è Retirer des Favoris';
									this.classList.add('favorited');
								} else {
									this.innerHTML = 'ü§ç Ajouter aux Favoris';
									this.classList.remove('favorited');
								}
							} else {
								alert('Erreur: ' + data.error);
							}
						} catch (parseError) {
							console.error('JSON parse error:', parseError);
							console.error('Raw response:', text);
							alert('Erreur de format de r√©ponse du serveur');
						}
					})
					.catch(error => {
						console.error('Network error:', error);
						alert('Erreur de connexion lors de la mise √† jour des favoris');
					});
				});
			}

			// Delete auction functionality
			const deleteBtn = document.querySelector('.delete-auction-btn');
			if (deleteBtn) {
				deleteBtn.addEventListener('click', function() {
					const auctionId = this.dataset.auctionId;
					
					if (confirm('√ätes-vous s√ªr de vouloir supprimer cette ench√®re ? Cette action est irr√©versible.')) {
						fetch(`/projetweb1/public/auctions/${auctionId}/delete`, {
							method: 'POST',
							headers: {
								'Content-Type': 'application/json',
							}
						})
						.then(response => response.json())
						.then(data => {
							if (data.success) {
								alert(data.message);
								window.location.href = '/projetweb1/public/auctions';
							} else {
								alert('Erreur: ' + data.error);
							}
						})
						.catch(error => {
							console.error('Error:', error);
							alert('Erreur lors de la suppression de l\'ench√®re');
						});
					}
				});
			}
		});
	</script>

	<footer class="footer">
		<div class="footer__content">
			<div class="footer__section">
				<h4 class="footer__subtitle">Liens Rapides</h4>
				<ul class="footer__links">
					<li><a href="/projetweb1/public/" class="footer__link">Accueil</a></li>
<li><a href="/projetweb1/public/auctions" class="footer__link">Ench√®res</a></li>
<li><a href="/projetweb1/public/auctions/create" class="footer__link">Cr√©er une Ench√®re</a></li>
<li><a href="/projetweb1/public/auctions/favorites" class="footer__link">Mes Favoris</a></li>
				</ul>
			</div>
			
			<div class="footer__section">
				<h4 class="footer__subtitle">Support</h4>
				<ul class="footer__links">
					<li><a href="#" class="footer__link">Centre d'Aide</a></li>
					<li><a href="#" class="footer__link">Contactez-nous</a></li>
					<li><a href="#" class="footer__link">FAQ</a></li>
					<li><a href="#" class="footer__link">Guide des Ench√®res</a></li>
				</ul>
			</div>
			
			<div class="footer__section">
				<h4 class="footer__subtitle">L√©gal</h4>
				<ul class="footer__links">
					<li><a href="#" class="footer__link">Conditions d'utilisation</a></li>
					<li><a href="#" class="footer__link">Politique de confidentialit√©</a></li>
					<li><a href="#" class="footer__link">R√®gles des ench√®res</a></li>
					<li><a href="#" class="footer__link">Protection des donn√©es</a></li>
				</ul>
			</div>
		</div>
		
		<div class="footer__bottom">
			<p class="footer__copyright">
				¬© 2024 Stampee Auction House. Tous droits r√©serv√©s.
			</p>
		</div>
	</footer>
</body>
</html>
